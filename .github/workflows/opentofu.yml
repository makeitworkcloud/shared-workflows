name: OpenTofu

on:
  workflow_call:
    inputs:
      environment:
        description: Environment for apply job
        type: string
        default: production
      runs-on:
        description: Runner label
        type: string
        default: ubuntu-latest
      container:
        description: Container image to use
        type: string
        default: ghcr.io/makeitworkcloud/runner:latest
      setup-ssh:
        description: Whether to setup SSH keys
        type: boolean
        default: false
    secrets:
      SOPS_AGE_KEY:
        required: true
      SSH_PRIVATE_KEY:
        required: false
      SSH_KNOWN_HOSTS:
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: Pre-commit Tests
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.container }}
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SSH key
        if: ${{ inputs.setup-ssh }}
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Copy SSH area
        if: ${{ inputs.setup-ssh }}
        run: cp -r /root/.ssh /github/home/

      - name: Initialize OpenTofu
        run: tofu init -backend=false

      - name: Run tests
        run: make test

  plan:
    name: OpenTofu Plan
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.container }}
    if: github.event_name == 'pull_request'
    needs: [test]
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH key
        if: ${{ inputs.setup-ssh }}
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Copy SSH area
        if: ${{ inputs.setup-ssh }}
        run: cp -r /root/.ssh /github/home/

      - name: OpenTofu Plan
        id: plan
        run: |
          make plan || true

          sed -n '/OpenTofu will perform the following actions:/,$p' plan-output.txt > plan-filtered.txt

          if [ ! -s plan-filtered.txt ]; then
            grep -A 2 "No changes" plan-output.txt > plan-filtered.txt || echo "No plan output found" > plan-filtered.txt
          fi

          tail -n 1000 plan-filtered.txt > plan-filtered-truncated.txt
          mv plan-filtered-truncated.txt plan-filtered.txt

      - name: prepare-comment
        run: |
          {
            echo '<!-- opentofu-plan -->'
            echo '#### OpenTofu Plan'
            echo '```'
            cat plan-filtered.txt
            echo '```'
          } > comment-body.md

      - name: comment
        uses: johanwulf/replace-comment@v1.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: '<!-- opentofu-plan -->'
          body-path: comment-body.md

  apply:
    name: OpenTofu Apply
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.container }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]
    environment: ${{ inputs.environment }}
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH key
        if: ${{ inputs.setup-ssh }}
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Copy SSH area
        if: ${{ inputs.setup-ssh }}
        run: cp -r /root/.ssh /github/home/

      - name: OpenTofu Apply
        run: make apply
