name: OpenTofu

on:
  workflow_call:
    inputs:
      environment:
        description: Environment for apply job
        type: string
        default: production
    secrets:
      SOPS_AGE_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: Pre-commit Tests
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/makeitworkcloud/runner:latest
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize OpenTofu
        run: tofu init -backend=false

      - name: Run tests
        run: make test

  plan:
    name: OpenTofu Plan
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/makeitworkcloud/runner:latest
    if: github.event_name == 'pull_request'
    needs: [test]
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OpenTofu Plan
        id: plan
        run: |
          make plan || true

          sed -n '/OpenTofu will perform the following actions:/,$p' plan-output.txt > plan-filtered.txt

          if [ ! -s plan-filtered.txt ]; then
            grep -A 2 "No changes" plan-output.txt > plan-filtered.txt || echo "No plan output found" > plan-filtered.txt
          fi

          tail -n 1000 plan-filtered.txt > plan-filtered-truncated.txt
          mv plan-filtered-truncated.txt plan-filtered.txt

      - name: prepare-comment
        run: |
          {
            echo '<!-- opentofu-plan -->'
            echo '#### OpenTofu Plan'
            echo '```'
            cat plan-filtered.txt
            echo '```'
          } > comment-body.md

      - name: find-comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- opentofu-plan -->'

      - name: delete-comment
        if: steps.fc.outputs.comment-id != ''
        run: gh api repos/${{ github.repository }}/issues/comments/${{ steps.fc.outputs.comment-id }} -X DELETE
        env:
          GH_TOKEN: ${{ github.token }}

      - name: comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment-body.md

  apply:
    name: OpenTofu Apply
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/makeitworkcloud/runner:latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]
    environment: ${{ inputs.environment }}
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OpenTofu Apply
        run: make apply
